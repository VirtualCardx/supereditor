<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor - SuperEditor</title>
    <!-- Ant Design CSS -->
    <link rel="stylesheet" href="https://unpkg.com/antd@5.21.6/dist/reset.css">
    <!-- Ant Design Icons -->
    <link rel="stylesheet" href="https://unpkg.com/@ant-design/icons@5.4.0/lib/index.css">
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github.min.css">
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://unpkg.com/katex@0.16.9/dist/katex.min.css">
    <style>
        :root {
            --primary-color: #2F4F39;
            --primary-hover: #233A2B;
            --primary-light: #7BA89E;
            --background-light: #E6E1D6;
            --text-color: #333;
            --text-secondary: #666;
            --border-color: #d9d9d9;
            --shadow: 0 3px 6px -4px rgba(0,0,0,.12), 0 6px 16px 0 rgba(0,0,0,.08), 0 9px 28px 8px rgba(0,0,0,.05);
            --card-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px 0 rgba(0, 0, 0, 0.02);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: var(--text-color);
        }

        .app-layout {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: white;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }

        .logo {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo::before {
            content: 'âœï¸';
            font-size: 24px;
        }

        .app-content {
            flex: 1;
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            height: calc(100vh - 112px);
        }

        @media (max-width: 1024px) {
            .app-content {
                grid-template-columns: 1fr;
                height: auto;
                gap: 16px;
            }
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: #fafafa;
            min-height: 56px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-header:first-child {
            border-bottom: none;
            background: white;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
            flex: 1;
        }

        .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            background: #fafafa;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .document-title-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            background: white;
            transition: all 0.3s;
        }

        .document-title-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(47, 79, 57, 0.1);
        }

        .document-title-input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            color: var(--text-secondary);
        }

        #editor {
            flex: 1.5;
            width: 100%;
            border: none;
            padding: 16px 20px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            background: white;
            color: var(--text-color);
            min-height: 400px;
        }

        #editor:focus {
            outline: none;
        }

        #editor:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            color: var(--text-secondary);
        }

        #preview {
            flex: 1.5;
            overflow-y: auto;
            padding: 16px 20px;
            border: none;
            background: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-color);
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            min-height: 400px;
        }

        .action-buttons {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            background: #fafafa;
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
        }

        /* æ¡Œé¢ç‰ˆæŒ‰é’®æ ·å¼ */
        .action-buttons .btn {
            flex: 1;
            min-width: 0;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 500;
            min-height: 44px;
        }

        .btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: white;
            color: var(--text-color);
            text-decoration: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .btn:hover {
            border-color: var(--primary-light);
            color: var(--primary-light);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .btn-success {
            background-color: #52c41a;
            border-color: #52c41a;
            color: white;
        }

        .btn-success:hover {
            background-color: #389e0d;
            border-color: #389e0d;
        }

        .btn-warning {
            background-color: #faad14;
            border-color: #faad14;
            color: white;
        }

        .btn-warning:hover {
            background-color: #d48806;
            border-color: #d48806;
        }

        .btn-info {
            background-color: #1890ff;
            border-color: #1890ff;
            color: white;
        }

        .btn-info:hover {
            background-color: #096dd9;
            border-color: #096dd9;
        }

        .btn-secondary {
            background-color: #f5f5f5;
            border-color: #d9d9d9;
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #e6f7ff;
            border-color: var(--primary-light);
            color: var(--primary-light);
        }

        .image-upload {
            display: none;
        }

        /* Upload progress positioning */
        #uploadStatus {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            min-width: 300px;
            max-width: 80%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .status {
            margin: 12px 20px;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
        }

        .status-error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }

        .status-success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-content {
                padding: 16px;
                height: calc(100vh - 96px);
                min-height: 800px;
            }

            .panel-header {
                padding: 12px 16px;
                min-height: 48px;
            }

            .toolbar {
                padding: 8px 16px;
            }

            #editor, #preview {
                padding: 12px 16px;
                min-height: 350px;
            }

            .action-buttons {
                padding: 12px 16px;
                gap: 4px;
                flex-wrap: nowrap;
                justify-content: space-between;
            }

            /* ä¼˜åŒ–ç§»åŠ¨ç«¯æŒ‰é’®æ ·å¼ */
            .action-buttons .btn {
                flex: 0 0 calc(20% - 5px);
                min-width: calc(20% - 5px);
                max-width: calc(20% - 5px);
                padding: 8px 4px;
                font-size: 12px;
                font-weight: 500;
                min-height: 38px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                border-radius: 6px;
                transition: all 0.2s ease;
            }

            /* ç§»åŠ¨ç«¯è¿›åº¦æ¡å®šä½ */
            #uploadStatus {
                top: 80px;
            }

            .header-content {
                padding: 0 16px;
                height: 56px;
            }

            .app-header {
                height: 56px;
            }

            /* Ensure panels have proper height on mobile */
            .panel {
                min-height: 400px;
            }

            .panel-content {
                min-height: 400px;
            }
        }

        @media (max-width: 480px) {
            .app-content {
                padding: 12px;
                height: calc(100vh - 80px);
                min-height: 700px;
                gap: 12px;
            }

            .logo span {
                display: none;
            }

            .btn {
                font-size: 11px;
                padding: 3px 6px;
            }

            .action-buttons {
                justify-content: space-between;
                padding: 8px 12px;
                flex-wrap: nowrap;
                gap: 3px;
            }

            /* ä¼˜åŒ–å°å±å¹•æŒ‰é’®å¸ƒå±€ */
            .action-buttons .btn {
                flex: 0 0 calc(20% - 3px);
                min-width: calc(20% - 3px);
                max-width: calc(20% - 3px);
                padding: 10px 3px;
                font-size: 13px;
                font-weight: 500;
                min-height: 42px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                border-radius: 6px;
                transition: all 0.2s ease;
            }

            /* å°å±å¹•è¿›åº¦æ¡å®šä½ */
            #uploadStatus {
                top: 60px;
            }

            .toolbar {
                padding: 6px 12px;
                gap: 4px;
            }

            .panel-header {
                padding: 8px 12px;
                min-height: 44px;
            }

            .header-content {
                padding: 0 12px;
                height: 48px;
            }

            .app-header {
                height: 48px;
            }

            /* Smaller minimum heights for very small screens */
            .panel {
                min-height: 300px;
            }

            .panel-content {
                min-height: 350px;
            }

            #editor, #preview {
                padding: 8px 12px;
                min-height: 300px;
                font-size: 13px;
            }

            /* Keep toolbar button text visible on all screen sizes */
            /* .toolbar .btn span:last-child {
                display: none;
            } */
        }

              /* Markdown preview styles */
        #preview h1 {
            font-size: 2em;
            font-weight: 600;
            margin: 1.5em 0 0.5em 0;
            padding-bottom: 0.3em;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-color);
        }

        #preview h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 1.2em 0 0.4em 0;
            padding-bottom: 0.2em;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }

        #preview h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 1em 0 0.3em 0;
            color: var(--text-color);
        }

        #preview h4, #preview h5, #preview h6 {
            font-weight: 600;
            margin: 0.8em 0 0.2em 0;
            color: var(--text-color);
        }

        #preview p {
            margin: 0.8em 0;
            line-height: 1.6;
            color: var(--text-color);
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        #preview ul, #preview ol {
            margin: 0.8em 0;
            padding-left: 2em;
        }

        #preview li {
            margin: 0.2em 0;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        #preview blockquote {
            margin: 1em 0;
            padding: 0 1em;
            color: var(--text-secondary);
            border-left: 4px solid var(--primary-light);
            background-color: #f9f9f9;
            border-radius: 0 4px 4px 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        #preview code {
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            background-color: rgba(47, 79, 57, 0.1);
            border-radius: 3px;
            font-family: 'SFMono-Regular', 'Consolas', 'Liberation Mono', 'Menlo', monospace;
            color: var(--primary-color);
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        #preview pre {
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f6f8fa;
            border-radius: 6px;
            margin: 1em 0;
            border: 1px solid var(--border-color);
        }

        #preview pre code {
            padding: 0;
            background: none;
            color: var(--text-color);
        }

        #preview table {
            border-spacing: 0;
            border-collapse: collapse;
            margin: 1em 0;
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        #preview table th, #preview table td {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            text-align: left;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 200px;
        }

        #preview table th {
            background-color: #fafafa;
            font-weight: 600;
            color: var(--text-color);
        }

        #preview table tr:nth-child(even) {
            background-color: #fafafa;
        }

        #preview hr {
            height: 1px;
            padding: 0;
            margin: 24px 0;
            background-color: var(--border-color);
            border: none;
        }

        #preview img {
            max-width: 100%;
            height: auto;
            margin: 12px 0;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Ensure images are displayed correctly in all modes */
        #preview img[src] {
            display: inline-block !important;
        }

        /* Fallback for broken images */
        #preview img[alt*="Image not found"] {
            display: inline-block !important;
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: center;
            font-style: italic;
            color: var(--text-secondary);
            border-radius: 6px;
        }

        /* Links in preview */
        #preview a {
            color: var(--primary-color);
            text-decoration: none;
        }

        #preview a:hover {
            text-decoration: underline;
            color: var(--primary-light);
        }

        /* Strong and emphasis */
        #preview strong {
            font-weight: 600;
            color: var(--text-color);
        }

        #preview em {
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Deleted text */
        #preview del {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        /* Enhanced code blocks with highlight.js */
        #pre > code {
            background: none !important;
            padding: 0 !important;
            color: inherit !important;
        }

        .hljs {
            background-color: #f6f8fa !important;
            padding: 16px !important;
            border-radius: 6px !important;
            font-size: 14px !important;
            line-height: 1.45 !important;
            overflow-x: auto !important;
            border: 1px solid var(--border-color) !important;
        }

        /* Inline code styling */
        #preview code:not(.hljs) {
            background-color: rgba(47, 79, 57, 0.1) !important;
            color: var(--primary-color) !important;
            padding: 0.2em 0.4em !important;
            border-radius: 3px !important;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace !important;
            font-size: 0.9em !important;
        }

        /* Math styling */
        .katex-display {
            margin: 1em 0;
            text-align: center;
        }

        .katex {
            font-size: 1em;
        }

        /* Task lists */
        #preview .task-list-item {
            list-style: none;
            margin-left: -1.5em;
        }

        #preview .task-list-item input {
            margin-right: 0.5em;
            transform: scale(1.2);
        }

        /* Enhanced table styling */
        #preview table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #preview table th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            font-weight: 600;
            text-align: left;
        }

        #preview table th,
        #preview table td {
            padding: 12px 16px;
            border: none;
            border-right: 1px solid var(--border-color);
        }

        #preview table th:last-child,
        #preview table td:last-child {
            border-right: none;
        }

        #preview table tr:nth-child(even) {
            background-color: #fafafa;
        }

        #preview table tr:hover {
            background-color: #f0f8ff;
        }

        /* Enhanced blockquote styling */
        #preview blockquote {
            margin: 1.5em 0;
            padding: 1em 1.5em;
            border-left: 5px solid var(--primary-color);
            background: linear-gradient(to right, rgba(47, 79, 57, 0.05), transparent);
            color: var(--text-secondary);
            font-style: italic;
            border-radius: 0 8px 8px 0;
        }

        #preview blockquote p {
            margin: 0;
        }

        /* Enhanced link styling */
        #preview a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            position: relative;
            transition: all 0.3s;
        }

        #preview a:hover {
            color: var(--primary-light);
            text-decoration: underline;
        }

        #preview a::after {
            content: '';
            font-size: 0.8em;
            margin-left: 4px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #preview a:hover::after {
            opacity: 1;
        }

        /* Enhanced heading styling */
        #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
            margin-top: 1.5em;
            margin-bottom: 1em;
            font-weight: 700;
            line-height: 1.3;
            color: var(--text-color);
        }

  
        #preview h1 {
            font-size: 2.2em;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 0.3em;
        }

        #preview h2 {
            font-size: 1.8em;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 0.2em;
        }

        /* Enhanced image styling */
        #preview img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            margin: 1.5em auto;
            display: block;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        #preview img:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.2);
        }

        /* Separator styling */
        #preview hr {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-light), transparent);
            border: none;
            margin: 3em 0;
            position: relative;
        }

        #preview hr::before {
            content: 'âœ¨';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 10px;
            color: var(--primary-light);
            font-size: 20px;
        }

        /* List styling improvements */
        #preview ul,
        #preview ol {
            padding-left: 2em;
            margin: 1em 0;
        }

        #preview li {
            margin: 0.5em 0;
            line-height: 1.6;
        }

        #preview ul li::marker {
            color: var(--primary-color);
        }

        #preview ol li::marker {
            color: var(--primary-light);
            font-weight: 600;
        }

        /* Code block copy button */
        .code-block-wrapper {
            position: relative;
            margin: 1.5em 0;
        }

        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .copy-button:hover {
            background: var(--primary-hover);
        }

        .copy-button.copied {
            background: #52c41a;
        }

        /* Mermaid diagram styling */
        .mermaid {
            text-align: center;
            margin: 2em 0;
            background: #f9f9f9;
            padding: 1em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        /* Upload progress bar styling */
        .upload-progress-container {
            padding: 16px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin: 8px 0;
        }

        .upload-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--text-color);
        }

        .upload-size {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .progress-bar {
            background-color: #f0f0f0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-light) 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .upload-percentage {
            text-align: center;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <header class="app-header">
            <div class="header-content">
                <a href="/dashboard/" class="logo"><span>SuperEditor</span></a>
                <div>
                    <button type="button" class="btn btn-secondary" id="backBtn">è¿”å›ä»ªè¡¨æ¿</button>
                </div>
            </div>
        </header>

        <div class="app-content">
            <div class="panel" id="editorPanel">
                <div class="panel-header">
                    <input type="text" class="document-title-input" id="documentTitle" placeholder="è¯·è¾“å…¥æ–‡æ¡£æ ‡é¢˜...">
                </div>

                <div class="panel-content">
                    <div class="toolbar">
                        <button type="button" class="btn btn-secondary" onclick="insertBold()" title="ç²—ä½“">
                            <span><strong>B</strong></span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="insertItalic()" title="æ–œä½“">
                            <span><em>I</em></span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="insertCode()" title="ä»£ç ">
                            <span><code>&lt;/&gt;</code></span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="insertLink()" title="é“¾æ¥">
                            <span>ğŸ”—</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="insertImage()" title="ä¸Šä¼ å›¾ç‰‡">
                            <span>ğŸ“¤</span>
                            <span>ä¸Šä¼ å›¾ç‰‡</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="insertFromGallery()" title="ä»å›¾åº“æ’å…¥">
                            <span>ğŸ–¼ï¸</span>
                            <span>ä»å›¾åº“æ’å…¥</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="insertTable()" title="æ’å…¥è¡¨æ ¼">
                            <span>ğŸ“Š</span>
                            <span>æ’å…¥è¡¨æ ¼</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="insertHr()" title="åˆ†éš”çº¿">
                            <span>â–</span>
                            <span>åˆ†éš”çº¿</span>
                        </button>
                    </div>

                    <textarea id="editor" placeholder="å¼€å§‹ç¼–å†™æ‚¨çš„ Markdown æ–‡æ¡£..."></textarea>

                    <div class="image-upload">
                        <input type="file" id="imageUpload" accept="image/*">
                    </div>
                    <div id="uploadStatus"></div>

                    <div class="action-buttons">
                        <button type="button" class="btn btn-success" id="expandBtn">
                            æ‰©å†™
                        </button>
                        <button type="button" class="btn btn-info" id="polishBtn">
                            æ¶¦è‰²
                        </button>
                        <button type="button" class="btn btn-warning" id="proofreadBtn">
                            æ ¡å¯¹
                        </button>
                        <button type="button" class="btn btn-primary" id="publishBtn">
                            å‘å¸ƒ
                        </button>
                        <button type="button" class="btn btn-primary" id="saveBtn">
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>

            <div class="panel" id="previewPanel">
                <div class="panel-header">
                    <h1 class="panel-title" id="documentPreviewTitle">æ–‡æ¡£é¢„è§ˆ</h1>
                </div>
                <div class="panel-content">
                    <div id="preview"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/marked@12.0.0/marked.min.js"></script>
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
    <script src="https://unpkg.com/katex@0.16.9/dist/katex.min.js"></script>
    <script>
        // ===========================================
        // SuperEditor Markdown ç¼–è¾‘å™¨æ ¸å¿ƒåŠŸèƒ½
        // ===========================================

        // é…ç½® marked.js çš„è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼Œæä¾›å¢å¼ºçš„ Markdown åŠŸèƒ½
        const renderer = new marked.Renderer();

        // å¢å¼ºçš„æ ‡é¢˜æ¸²æŸ“å™¨ - ä¸ºæ ‡é¢˜æ·»åŠ é”šç‚¹ ID
        renderer.heading = function(text, level) {
            // å°†æ ‡é¢˜æ–‡æœ¬è½¬æ¢ä¸ºæœ‰æ•ˆçš„é”šç‚¹ ID
            const escapedText = text.toLowerCase().replace(/[^\w]+/g, '-');
            return `<h${level} id="${escapedText}">${text}</h${level}>`;
        };

        // å¢å¼ºçš„å›¾ç‰‡æ¸²æŸ“å™¨ - æ”¯æŒæ‡’åŠ è½½å’Œé”™è¯¯å¤„ç†
        renderer.image = function(href, title, text) {
            const titleAttr = title ? ` title="${title}"` : '';
            const altAttr = text ? ` alt="${text}"` : ' alt="Image"';
            // æ·»åŠ æ‡’åŠ è½½ã€åœ†è§’ã€é˜´å½±å’Œé”™è¯¯å¤„ç†
            return `<img src="${href}"${titleAttr}${altAttr} loading="lazy" style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);" onerror="this.alt='Image not found: ' + this.src; this.style.border='1px solid var(--border-color)'; this.style.padding='10px'; this.style.backgroundColor='#f9f9f9';">`;
        };

        // å¢å¼ºçš„é“¾æ¥æ¸²æŸ“å™¨ - ä¸ºå¤–éƒ¨é“¾æ¥æ·»åŠ å›¾æ ‡å’Œæ–°çª—å£æ‰“å¼€
        renderer.link = function(href, title, text) {
            const isExternal = href && (href.startsWith('http') || href.startsWith('//'));
            const titleAttr = title ? ` title="${title}"` : '';
            const externalIcon = isExternal ? '<span class="external-link"></span>' : '';
            return `<a href="${href}"${titleAttr} target="${isExternal ? '_blank' : '_self'}" rel="${isExternal ? 'noopener noreferrer' : ''}">${text}${externalIcon}</a>`;
        };

        // å¢å¼ºçš„ä»£ç å—æ¸²æŸ“å™¨ - æ”¯æŒè¯­æ³•é«˜äº®å’Œå¤åˆ¶åŠŸèƒ½
        renderer.code = function(code, language) {
            // éªŒè¯è¯­è¨€æ˜¯å¦å—æ”¯æŒï¼Œå¦åˆ™ä½¿ç”¨çº¯æ–‡æœ¬
            const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
            const highlightedCode = hljs.highlight(code, { language: validLanguage }).value;
            // ç”Ÿæˆå”¯ä¸€çš„å¤åˆ¶æŒ‰é’® ID
            const copyId = 'copy-' + Math.random().toString(36).substr(2, 9);

            return `
                <div class="code-block-wrapper">
                    <button class="copy-button" onclick="copyCode('${copyId}', this)" title="å¤åˆ¶ä»£ç ">å¤åˆ¶</button>
                    <pre><code id="${copyId}" class="hljs language-${validLanguage}">${highlightedCode}</code></pre>
                </div>
            `;
        };

        // å¢å¼ºçš„å¼•ç”¨å—æ¸²æŸ“å™¨
        renderer.blockquote = function(quote) {
            return `<blockquote>${quote}</blockquote>`;
        };

        // å¢å¼ºçš„è¡¨æ ¼æ¸²æŸ“å™¨
        renderer.table = function(header, body) {
            return `
                <div class="table-wrapper">
                    <table>
                        <thead>${header}</thead>
                        <tbody>${body}</tbody>
                    </table>
                </div>
            `;
        };

        // å¢å¼ºçš„åˆ—è¡¨é¡¹æ¸²æŸ“å™¨ - æ”¯æŒä»»åŠ¡åˆ—è¡¨
        renderer.listitem = function(text, isTask, isChecked) {
            if (isTask) {
                return `<li class="task-list-item">
                    <input type="checkbox" ${isChecked ? 'checked' : ''} disabled>
                    ${text}
                </li>`;
            }
            return `<li>${text}</li>`;
        };

        // é…ç½® marked.js é€‰é¡¹
        marked.setOptions({
            renderer: renderer,
            // ä½¿ç”¨ highlight.js è¿›è¡Œä»£ç è¯­æ³•é«˜äº®
            highlight: function(code, lang) {
                const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                return hljs.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-',
            pedantic: false,        // ä¸ä¸¥æ ¼éµå¾ªåŸå§‹ markdown è§„èŒƒ
            gfm: true,              // å¯ç”¨ GitHub Flavored Markdown
            breaks: true,           // æ”¯æŒæ¢è¡Œç¬¦è½¬æ¢
            sanitize: false,        // ä¸æ¸…ç† HTMLï¼ˆå…è®¸åµŒå…¥ HTMLï¼‰
            smart: true,            // å¯ç”¨æ™ºèƒ½æ ‡ç‚¹ç¬¦å·
            smartLists: true,       // æ™ºèƒ½åˆ—è¡¨å¤„ç†
            smartypants: true       // æ™ºèƒ½å¼•å·å’Œç ´æŠ˜å·
        });

        // ===========================================
        // æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
        // ===========================================

        // å¢å¼ºçš„ Markdown è§£æå‡½æ•°
        function parseMarkdown(text) {
            if (!text) return '';

            try {
                // ç¬¬ä¸€æ­¥ï¼šå¤„ç† LaTeX æ•°å­¦å…¬å¼
                let processedText = processMathExpressions(text);

                // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ marked è§£æ Markdown
                let html = marked.parse(processedText);

                // ç¬¬ä¸‰æ­¥ï¼šåå¤„ç† HTML ä»¥æ·»åŠ é¢å¤–åŠŸèƒ½
                html = postProcessMarkdown(html);

                return html;
            } catch (error) {
                console.error('Markdown è§£æé”™è¯¯:', error);
                return `<p>Markdown è§£æé”™è¯¯: ${error.message}</p>`;
            }
        }

        // å¤„ç† LaTeX æ•°å­¦è¡¨è¾¾å¼
        function processMathExpressions(text) {
            // å¤„ç†å—çº§æ•°å­¦å…¬å¼ ($$...$$)
            text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                try {
                    return katex.renderToString(math, {
                        displayMode: true,    // å—çº§æ˜¾ç¤ºæ¨¡å¼
                        throwOnError: false   // é”™è¯¯æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
                    });
                } catch (e) {
                    return `<span class="math-error">æ•°å­¦å…¬å¼é”™è¯¯: ${e.message}</span>`;
                }
            });

            // å¤„ç†è¡Œå†…æ•°å­¦å…¬å¼ ($...$)
            text = text.replace(/\$([^\$\n]+?)\$/g, (match, math) => {
                try {
                    return katex.renderToString(math, {
                        displayMode: false,   // è¡Œå†…æ˜¾ç¤ºæ¨¡å¼
                        throwOnError: false
                    });
                } catch (e) {
                    return `<span class="math-error">æ•°å­¦å…¬å¼é”™è¯¯: ${e.message}</span>`;
                }
            });

            return text;
        }

        // åå¤„ç† Markdown HTMLï¼Œæ·»åŠ é¢å¤–åŠŸèƒ½
        function postProcessMarkdown(html) {
            // ä¸ºé”šç‚¹é“¾æ¥æ·»åŠ å¹³æ»‘æ»šåŠ¨è¡Œä¸º
            html = html.replace(/<a href="#([^"]+)"/g, '<a href="#$1" onclick="smoothScroll(\'$1\'); return false;"');

            // å¤„ç† Mermaid å›¾è¡¨ä»£ç å—
            html = html.replace(/```mermaid\n([\s\S]*?)\n```/g, (match, code) => {
                return `<div class="mermaid">${code.trim()}</div>`;
            });

            return html;
        }

        // å¤åˆ¶ä»£ç åŠŸèƒ½
        function copyCode(elementId, button) {
            const codeElement = document.getElementById(elementId);
            if (codeElement) {
                // ä½¿ç”¨ç°ä»£å‰ªè´´æ¿ API
                navigator.clipboard.writeText(codeElement.textContent).then(() => {
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    button.textContent = 'å·²å¤åˆ¶';
                    button.classList.add('copied');
                    // 2ç§’åæ¢å¤åŸå§‹çŠ¶æ€
                    setTimeout(() => {
                        button.textContent = 'å¤åˆ¶';
                        button.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ä»£ç å¤åˆ¶');
                });
            }
        }

        // å¹³æ»‘æ»šåŠ¨åˆ°æŒ‡å®šå…ƒç´ 
        function smoothScroll(targetId) {
            const element = document.getElementById(targetId);
            if (element) {
                element.scrollIntoView({
                    behavior: 'smooth',  // å¹³æ»‘æ»šåŠ¨
                    block: 'start'       // æ»šåŠ¨åˆ°å…ƒç´ é¡¶éƒ¨
                });
            }
        }

        // HTML è½¬ä¹‰å·¥å…·å‡½æ•°ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è°ƒè¯•å‡½æ•°ï¼šéªŒè¯å›¾ç‰‡è§£æï¼ˆç”Ÿäº§ç¯å¢ƒå¯ç§»é™¤ï¼‰
        function debugImageParsing(text) {
            const imageRegex = /!\[([^\]]*)\]\(([^)]+)\)/g;
            const matches = text.match(imageRegex);
            if (matches && matches.length > 0) {
                console.log('Found images in markdown:', matches);
            }
            return matches || [];
        }

        // ===========================================
        // é¢„è§ˆç•Œé¢æ›´æ–°åŠŸèƒ½
        // ===========================================

        // æ›´æ–°é¢„è§ˆæ ‡é¢˜
        function updatePreviewTitle(title, viewMode = false) {
            const previewTitle = document.getElementById('documentPreviewTitle');

            if (title && title.trim()) {
                previewTitle.textContent = title;
            } else {
                previewTitle.textContent = 'æ–‡æ¡£é¢„è§ˆ';
            }
        }

        // æ›´æ–°é¢„è§ˆå†…å®¹
        function updatePreview() {
            const editor = document.getElementById('editor');
            const preview = document.getElementById('preview');
            const parsedContent = parseMarkdown(editor.value);
            preview.innerHTML = parsedContent;

            // ç¡®ä¿æ‰€æœ‰å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º
            const images = preview.querySelectorAll('img');
            images.forEach(img => {
                // å¼ºåˆ¶è®¾ç½®å›¾ç‰‡æ˜¾ç¤ºæ ·å¼
                img.style.display = 'inline-block';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';

                // æ·»åŠ é”™è¯¯å¤„ç†ï¼ˆå¦‚æœå°šæœªæ·»åŠ ï¼‰
                if (!img.hasAttribute('onerror')) {
                    img.onerror = function() {
                        this.alt = 'Image not found: ' + this.src;
                        this.style.border = '1px solid #ccc';
                        this.style.padding = '5px';
                        this.style.backgroundColor = '#f9f9f9';
                    };
                }
            });
        }

        // ===========================================
        // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
        // ===========================================

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ äº‹ä»¶
        document.getElementById('imageUpload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                const statusDiv = document.getElementById('uploadStatus');
                statusDiv.innerHTML = `
                    <div class="upload-progress-container">
                        <div class="upload-info">
                            <span>æ­£åœ¨ä¸Šä¼ : ${file.name}</span>
                            <span class="upload-size">(${formatFileSizeBytes(file.size)})</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="uploadProgress"></div>
                        </div>
                        <div class="upload-percentage" id="uploadPercentage">0%</div>
                    </div>
                `;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    // åˆ›å»º XMLHttpRequest ä»¥æ”¯æŒè¿›åº¦æ¡
                    const xhr = new XMLHttpRequest();

                    // ç›‘å¬ä¸Šä¼ è¿›åº¦
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = Math.round((e.loaded / e.total) * 100);
                            const progressBar = document.getElementById('uploadProgress');
                            const percentageText = document.getElementById('uploadPercentage');

                            if (progressBar) {
                                progressBar.style.width = percentComplete + '%';
                            }
                            if (percentageText) {
                                percentageText.textContent = percentComplete + '%';
                            }
                        }
                    });

                    // ç›‘å¬ä¸Šä¼ å®Œæˆ
                    xhr.addEventListener('load', function() {
                        if (xhr.status === 200) {
                            const data = JSON.parse(xhr.responseText);
                            statusDiv.innerHTML = '<div class="status status-success">âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼</div>';

                            // å°†å›¾ç‰‡ Markdown æ’å…¥åˆ°ç¼–è¾‘å™¨ä¸­
                            const editor = document.getElementById('editor');
                            const imageMarkdown = `\n![${file.name}](${data.url})\n`;
                            const cursorPos = editor.selectionStart;
                            const textBefore = editor.value.substring(0, cursorPos);
                            const textAfter = editor.value.substring(cursorPos);
                            editor.value = textBefore + imageMarkdown + textAfter;
                            updatePreview();
                        } else {
                            try {
                                const errorData = JSON.parse(xhr.responseText);
                                statusDiv.innerHTML = `<div class="status status-error">âŒ ä¸Šä¼ å¤±è´¥: ${errorData.error}</div>`;
                            } catch {
                                statusDiv.innerHTML = `<div class="status status-error">âŒ ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•</div>`;
                            }
                        }
                    });

                    // ç›‘å¬ä¸Šä¼ é”™è¯¯
                    xhr.addEventListener('error', function() {
                        statusDiv.innerHTML = '<div class="status status-error">âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥</div>';
                    });

                    // å‘é€ä¸Šä¼ è¯·æ±‚
                    xhr.open('POST', '/api/images/upload');
                    xhr.withCredentials = true;  // åŒ…å«è®¤è¯ä¿¡æ¯
                    xhr.send(formData);

                } catch (error) {
                    // ç½‘ç»œé”™è¯¯
                    statusDiv.innerHTML = `<div class="status status-error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
                }

                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
                e.target.value = '';

                // 5ç§’åæ¸…é™¤çŠ¶æ€æ¶ˆæ¯
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        });

        // ===========================================
        // æ–‡æ¡£æ“ä½œåŠŸèƒ½ï¼ˆä¿å­˜ã€AIå¤„ç†ã€å‘å¸ƒç­‰ï¼‰
        // ===========================================

        // ä¿å­˜æ–‡æ¡£
        document.getElementById('saveBtn').addEventListener('click', async () => {
            const title = document.getElementById('documentTitle').value;
            const content = document.getElementById('editor').value;

            // éªŒè¯æ ‡é¢˜æ˜¯å¦ä¸ºç©º
            if (!title) {
                alert('è¯·è¾“å…¥æ–‡æ¡£æ ‡é¢˜');
                return;
            }

            // è·å–æ–‡æ¡£IDï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰æˆ–åˆ›å»ºæ–°æ–‡æ¡£
            const urlParams = new URLSearchParams(window.location.search);
            const documentId = urlParams.get('id');

            try {
                let response;
                if (documentId) {
                    // æ›´æ–°ç°æœ‰æ–‡æ¡£
                    response = await fetch(`/api/documents/${documentId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title, content }),
                        credentials: 'include'
                    });
                } else {
                    // åˆ›å»ºæ–°æ–‡æ¡£
                    response = await fetch('/api/documents', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title, content }),
                        credentials: 'include'
                    });
                }

                if (response.ok) {
                    alert('æ–‡æ¡£ä¿å­˜æˆåŠŸï¼');
                    // å¯ä»¥æ ¹æ®éœ€è¦é‡å®šå‘åˆ°ä»ªè¡¨æ¿æˆ–ä¿æŒå½“å‰é¡µé¢
                } else {
                    const data = await response.json();
                    alert(`ä¿å­˜æ–‡æ¡£æ—¶å‡ºé”™: ${data.error}`);
                }
            } catch (error) {
                console.error('ä¿å­˜æ–‡æ¡£é”™è¯¯:', error);
                alert('ä¿å­˜æ–‡æ¡£æ—¶å‡ºç°ç½‘ç»œé”™è¯¯');
            }
        });

        // AI æ‰©å†™æ–‡æ¡£
        document.getElementById('expandBtn').addEventListener('click', async () => {
            const title = document.getElementById('documentTitle').value;
            const content = document.getElementById('editor').value;

            // éªŒè¯å†…å®¹æ˜¯å¦ä¸ºç©º
            if (!content.trim()) {
                alert('è¯·å…ˆè¾“å…¥ä¸€äº›å†…å®¹å†è¿›è¡Œæ‰©å†™');
                return;
            }

            try {
                // å‘é€æ‰©å†™è¯·æ±‚åˆ° AI æœåŠ¡
                const response = await fetch('/api/ai/expand', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹å¹¶åˆ·æ–°é¢„è§ˆ
                    document.getElementById('editor').value = data.expandedContent;
                    updatePreview();
                    alert('æ–‡ç« æ‰©å†™å®Œæˆï¼');
                } else {
                    const errorData = await response.json();
                    alert(`æ‰©å†™å¤±è´¥: ${errorData.error}`);
                }
            } catch (error) {
                console.error('æ‰©å†™æ–‡æ¡£é”™è¯¯:', error);
                alert('æ‰©å†™æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯');
            }
        });

        // AI æ¶¦è‰²æ–‡æ¡£
        document.getElementById('polishBtn').addEventListener('click', async () => {
            const title = document.getElementById('documentTitle').value;
            const content = document.getElementById('editor').value;

            // éªŒè¯å†…å®¹æ˜¯å¦ä¸ºç©º
            if (!content.trim()) {
                alert('è¯·å…ˆè¾“å…¥ä¸€äº›å†…å®¹å†è¿›è¡Œæ¶¦è‰²');
                return;
            }

            try {
                // å‘é€æ¶¦è‰²è¯·æ±‚åˆ° AI æœåŠ¡
                const response = await fetch('/api/ai/polish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹å¹¶åˆ·æ–°é¢„è§ˆ
                    document.getElementById('editor').value = data.polishedContent;
                    updatePreview();
                    alert('æ–‡ç« æ¶¦è‰²å®Œæˆï¼');
                } else {
                    const errorData = await response.json();
                    alert(`æ¶¦è‰²å¤±è´¥: ${errorData.error}`);
                }
            } catch (error) {
                console.error('æ¶¦è‰²æ–‡æ¡£é”™è¯¯:', error);
                alert('æ¶¦è‰²æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯');
            }
        });

        // AI æ ¡å¯¹æ–‡æ¡£
        document.getElementById('proofreadBtn').addEventListener('click', async () => {
            const title = document.getElementById('documentTitle').value;
            const content = document.getElementById('editor').value;

            // éªŒè¯å†…å®¹æ˜¯å¦ä¸ºç©º
            if (!content.trim()) {
                alert('è¯·å…ˆè¾“å…¥ä¸€äº›å†…å®¹å†è¿›è¡Œæ ¡å¯¹');
                return;
            }

            try {
                // å‘é€æ ¡å¯¹è¯·æ±‚åˆ° AI æœåŠ¡
                const response = await fetch('/api/ai/proofread', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title, content }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    // æ˜¾ç¤ºæ ¡å¯¹å»ºè®®æˆ–ç¡®è®¤ä¿¡æ¯
                    if (data.suggestions && data.suggestions.length > 0) {
                        alert(`æ ¡å¯¹å»ºè®®ï¼š\n${data.suggestions.join('\n')}`);
                    } else {
                        alert('æ–‡ç« æ£€æŸ¥å®Œæˆï¼Œæœªå‘ç°é—®é¢˜ï¼');
                    }
                } else {
                    const errorData = await response.json();
                    alert(`æ ¡å¯¹å¤±è´¥: ${errorData.error}`);
                }
            } catch (error) {
                console.error('æ ¡å¯¹æ–‡æ¡£é”™è¯¯:', error);
                alert('æ ¡å¯¹æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯');
            }
        });

        // å‘å¸ƒåˆ° WordPress
        document.getElementById('publishBtn').addEventListener('click', async () => {
            const title = document.getElementById('documentTitle').value;
            const content = document.getElementById('editor').value;

            // éªŒè¯æ ‡é¢˜å’Œå†…å®¹æ˜¯å¦ä¸ºç©º
            if (!title.trim() || !content.trim()) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹åå†å‘å¸ƒ');
                return;
            }

            // ç¡®è®¤å‘å¸ƒæ“ä½œ
            if (confirm('ç¡®å®šè¦å‘å¸ƒåˆ°WordPresså—ï¼Ÿ')) {
                try {
                    // å‘é€å‘å¸ƒè¯·æ±‚åˆ° WordPress API
                    const response = await fetch('/api/wordpress/publish', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title, content }),
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        alert(`å‘å¸ƒæˆåŠŸï¼æ–‡ç« é“¾æ¥ï¼š${data.url}`);
                    } else {
                        const errorData = await response.json();
                        alert(`å‘å¸ƒå¤±è´¥: ${errorData.error}`);
                    }
                } catch (error) {
                    console.error('WordPresså‘å¸ƒé”™è¯¯:', error);
                    alert('å‘å¸ƒæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯');
                }
            }
        });

        // ===========================================
        // é¡µé¢å¯¼èˆªå’Œåˆå§‹åŒ–åŠŸèƒ½
        // ===========================================

        // è¿”å›ä»ªè¡¨æ¿
        document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = '/dashboard/';
        });

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–æ“ä½œ
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const documentId = urlParams.get('id');
            const viewMode = urlParams.get('view') === 'true';

            if (viewMode) {
                // åªè¯»æ¨¡å¼ï¼šéšè—ç¼–è¾‘å™¨é¢æ¿
                const editorPanel = document.getElementById('editorPanel');
                editorPanel.style.display = 'none';

                // è®©é¢„è§ˆé¢æ¿å æ®å…¨å®½
                const previewPanel = document.getElementById('previewPanel');
                previewPanel.style.gridColumn = '1 / -1';

                // ç¡®ä¿å›¾ç‰‡åœ¨åªè¯»æ¨¡å¼ä¸‹æ­£ç¡®æ˜¾ç¤º
                const preview = document.getElementById('preview');
                preview.style.maxWidth = '100%';
                preview.style.overflow = 'auto';
            }

            if (documentId) {
                // ç¼–è¾‘ç°æœ‰æ–‡æ¡£
                try {
                    const response = await fetch(`/api/documents/${documentId}`, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const doc = await response.json();
                        document.getElementById('documentTitle').value = doc.title;
                        document.getElementById('editor').value = doc.content;

                        // æ›´æ–°é¢„è§ˆæ ‡é¢˜å’Œå†…å®¹
                        updatePreviewTitle(doc.title, viewMode);
                        updatePreview();

                        // åªè¯»æ¨¡å¼ä¸‹å°†ç¼–è¾‘å™¨è®¾ä¸ºåªè¯»
                        if (viewMode) {
                            document.getElementById('documentTitle').readOnly = true;
                            document.getElementById('editor').readOnly = true;
                        }
                    } else {
                        const data = await response.json();
                        alert(`åŠ è½½æ–‡æ¡£æ—¶å‡ºé”™: ${data.error}`);
                    }
                } catch (error) {
                    console.error('åŠ è½½æ–‡æ¡£é”™è¯¯:', error);
                    alert('åŠ è½½æ–‡æ¡£æ—¶å‡ºç°ç½‘ç»œé”™è¯¯');
                }
            } else {
                // æ–°æ–‡æ¡£ï¼šåˆå§‹åŒ–ç©ºæ ‡é¢˜
                updatePreviewTitle('', viewMode);
                updatePreview();
            }
        });

        // ===========================================
        // å®æ—¶é¢„è§ˆæ›´æ–°åŠŸèƒ½
        // ===========================================

        // å½“ç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­è¾“å…¥æ—¶å®æ—¶æ›´æ–°é¢„è§ˆ
        document.getElementById('editor').addEventListener('input', updatePreview);

        // å½“ç”¨æˆ·è¾“å…¥æ ‡é¢˜æ—¶å®æ—¶æ›´æ–°é¢„è§ˆæ ‡é¢˜
        document.getElementById('documentTitle').addEventListener('input', () => {
            const title = document.getElementById('documentTitle').value;
            const urlParams = new URLSearchParams(window.location.search);
            const viewMode = urlParams.get('view') === 'true';
            updatePreviewTitle(title, viewMode);
        });

        // ===========================================
        // ç¼–è¾‘å™¨å·¥å…·æ åŠŸèƒ½
        // ===========================================

        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬
        function insertTextAtCursor(text, textarea = document.getElementById('editor')) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;

            textarea.value = value.substring(0, start) + text + value.substring(end);

            // å°†å…‰æ ‡ç§»åŠ¨åˆ°æ’å…¥æ–‡æœ¬ä¹‹å
            const newPosition = start + text.length;
            textarea.setSelectionRange(newPosition, newPosition);
            textarea.focus();
        }

        // Markdown æ ¼å¼åŒ–å‡½æ•°ç»„

        // æ’å…¥ç²—ä½“æ ¼å¼
        function insertBold() {
            const textarea = document.getElementById('editor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end) || 'ç²—ä½“æ–‡æœ¬';
            const formattedText = `**${selectedText}**`;

            insertTextAtCursor(formattedText);
            updatePreview();
        }

        // æ’å…¥æ–œä½“æ ¼å¼
        function insertItalic() {
            const textarea = document.getElementById('editor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end) || 'æ–œä½“æ–‡æœ¬';
            const formattedText = `*${selectedText}*`;

            insertTextAtCursor(formattedText);
            updatePreview();
        }

        // æ’å…¥è¡Œå†…ä»£ç æ ¼å¼
        function insertCode() {
            const textarea = document.getElementById('editor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end) || 'ä»£ç ';
            const formattedText = `\`${selectedText}\``;

            insertTextAtCursor(formattedText);
            updatePreview();
        }

        // æ’å…¥é“¾æ¥æ ¼å¼
        function insertLink() {
            const textarea = document.getElementById('editor');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end) || 'é“¾æ¥æ–‡æœ¬';
            const formattedText = `[${selectedText}](url)`;

            insertTextAtCursor(formattedText);
            updatePreview();
        }

        // æ’å…¥å›¾ç‰‡ï¼ˆè§¦å‘æ–‡ä»¶ä¸Šä¼ å¯¹è¯æ¡†ï¼‰
        function insertImage() {
            document.getElementById('imageUpload').click();
        }

        // æ’å…¥è¡¨æ ¼æ¨¡æ¿
        function insertTable() {
            const formattedText = '\n| åˆ—1 | åˆ—2 | åˆ—3 |\n|-----|-----|-----|\n| å†…å®¹1 | å†…å®¹2 | å†…å®¹3 |\n';
            insertTextAtCursor(formattedText);
            updatePreview();
        }

        // æ’å…¥æ°´å¹³åˆ†å‰²çº¿
        function insertHr() {
            const formattedText = '\n---\n';
            insertTextAtCursor(formattedText);
            updatePreview();
        }

        // ===========================================
        // é”®ç›˜å¿«æ·é”®åŠŸèƒ½
        // ===========================================

        // å¤„ç†ç¼–è¾‘å™¨ä¸­çš„ Tab é”®è¾“å…¥
        document.getElementById('editor').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();  // é˜»æ­¢é»˜è®¤çš„ Tab é”®è¡Œä¸ºï¼ˆå¤±å»ç„¦ç‚¹ï¼‰

                // åœ¨ Markdown ä¸­æ’å…¥ 4 ä¸ªç©ºæ ¼ä»£æ›¿ Tab å­—ç¬¦
                const textarea = this;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const value = textarea.value;

                // æ’å…¥ 4 ä¸ªç©ºæ ¼ä»¥æé«˜ Markdown å…¼å®¹æ€§
                const tabText = '    ';
                textarea.value = value.substring(0, start) + tabText + value.substring(end);

                // å°†å…‰æ ‡ç§»åŠ¨åˆ°æ’å…¥çš„ Tab ä¹‹å
                const newPosition = start + tabText.length;
                textarea.setSelectionRange(newPosition, newPosition);

                // è§¦å‘é¢„è§ˆæ›´æ–°
                updatePreview();
            }
        });
    </script>

    <!-- å›¾åº“é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="galleryModal" class="modal" style="display: none;">
        <div class="modal-content gallery-modal">
            <div class="modal-header">
                <h3>é€‰æ‹©å›¾ç‰‡</h3>
                <span class="close" onclick="closeGalleryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="gallery-controls">
                    <input type="text" id="gallerySearch" placeholder="æœç´¢å›¾ç‰‡..." class="gallery-search">
                    <button type="button" class="btn btn-secondary" onclick="refreshGallery()">
                        <span>ğŸ”„</span>
                        <span>åˆ·æ–°</span>
                    </button>
                </div>
                <div id="galleryLoading" class="gallery-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>åŠ è½½å›¾ç‰‡ä¸­...</p>
                </div>
                <div id="galleryImages" class="gallery-images">
                    <!-- å›¾ç‰‡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
                <div id="galleryPagination" class="gallery-pagination">
                    <!-- åˆ†é¡µæ§ä»¶å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeGalleryModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="insertSelectedBtn" onclick="insertSelectedImages()" disabled>
                    <span>âœ“</span>
                    <span>æ’å…¥é€‰ä¸­å›¾ç‰‡</span>
                </button>
            </div>
        </div>
    </div>

    <!-- å›¾åº“æ¨¡æ€æ¡†æ ·å¼ -->
    <style>
        .gallery-modal {
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
        }

        .gallery-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .gallery-search {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .gallery-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .gallery-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .gallery-item {
            position: relative;
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f9f9f9;
        }

        .gallery-item:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .gallery-item.selected {
            border-color: #28a745;
            background: #e8f5e8;
        }

        .gallery-item.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 5px;
            right: 5px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .gallery-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .gallery-item-info {
            padding: 8px;
            font-size: 12px;
            color: #666;
            background: white;
        }

        .gallery-item-name {
            font-weight: bold;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .gallery-item-size {
            color: #999;
        }

        .gallery-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .gallery-pagination button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .gallery-pagination button:hover:not(:disabled) {
            background: #f0f0f0;
        }

        .gallery-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .gallery-pagination .page-info {
            color: #666;
            font-size: 14px;
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px 24px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }
    </style>

    <!-- å›¾åº“ç›¸å…³JavaScript -->
    <script>
        let galleryImages = [];
        let selectedImages = [];
        let currentCursor = null;
        let hasMoreImages = false;

        // ä»å›¾åº“æ’å…¥å›¾ç‰‡
        function insertFromGallery() {
            openGalleryModal();
        }

        // æ‰“å¼€å›¾åº“æ¨¡æ€æ¡†
        function openGalleryModal() {
            document.getElementById('galleryModal').style.display = 'block';
            selectedImages = [];
            loadGalleryImages();
        }

        // å…³é—­å›¾åº“æ¨¡æ€æ¡†
        function closeGalleryModal() {
            document.getElementById('galleryModal').style.display = 'none';
            selectedImages = [];
            updateInsertButton();
        }

        // åŠ è½½å›¾åº“å›¾ç‰‡
        async function loadGalleryImages(search = '') {
            const loadingDiv = document.getElementById('galleryLoading');
            const imagesDiv = document.getElementById('galleryImages');
            const paginationDiv = document.getElementById('galleryPagination');

            loadingDiv.style.display = 'block';
            imagesDiv.innerHTML = '';
            paginationDiv.innerHTML = '';

            try {
                const url = new URL('/api/images', window.location.origin);
                if (search) url.searchParams.append('search', search);
                if (currentCursor) url.searchParams.append('cursor', currentCursor);

                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    galleryImages = data.images || [];
                    hasMoreImages = data.hasMore || false;
                    currentCursor = data.cursor || null;

                    displayGalleryImages(galleryImages);
                    updatePagination();
                } else {
                    const error = await response.json();
                    imagesDiv.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc3545;">åŠ è½½å¤±è´¥: ${error.error}</div>`;
                }
            } catch (error) {
                console.error('Failed to load gallery images:', error);
                imagesDiv.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc3545;">ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºå›¾åº“å›¾ç‰‡
        function displayGalleryImages(images) {
            const imagesDiv = document.getElementById('galleryImages');

            if (images.length === 0) {
                imagesDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— å›¾ç‰‡</div>';
                return;
            }

            imagesDiv.innerHTML = images.map(image => `
                <div class="gallery-item" data-image-id="${image.id}" onclick="toggleImageSelection('${image.id}')">
                    <img src="${image.url}" alt="${image.name}" loading="lazy">
                    <div class="gallery-item-info">
                        <div class="gallery-item-name">${image.name}</div>
                        <div class="gallery-item-size">
                            ${image.width && image.height ? `${image.width}Ã—${image.height}` : ''}
                            ${image.size ? ` â€¢ ${formatFileSize(image.size)}` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // åˆ‡æ¢å›¾ç‰‡é€‰æ‹©çŠ¶æ€
        function toggleImageSelection(imageId) {
            const index = selectedImages.indexOf(imageId);
            if (index > -1) {
                selectedImages.splice(index, 1);
            } else {
                selectedImages.push(imageId);
            }

            // æ›´æ–°UI
            const galleryItem = document.querySelector(`[data-image-id="${imageId}"]`);
            if (galleryItem) {
                galleryItem.classList.toggle('selected');
            }

            updateInsertButton();
        }

        // æ›´æ–°æ’å…¥æŒ‰é’®çŠ¶æ€
        function updateInsertButton() {
            const insertBtn = document.getElementById('insertSelectedBtn');
            insertBtn.disabled = selectedImages.length === 0;

            if (selectedImages.length > 0) {
                insertBtn.innerHTML = `<span>âœ“</span><span>æ’å…¥é€‰ä¸­å›¾ç‰‡ (${selectedImages.length})</span>`;
            } else {
                insertBtn.innerHTML = '<span>âœ“</span><span>æ’å…¥é€‰ä¸­å›¾ç‰‡</span>';
            }
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination() {
            const paginationDiv = document.getElementById('galleryPagination');

            if (hasMoreImages || currentCursor) {
                paginationDiv.innerHTML = `
                    <button onclick="loadPreviousPage()" ${!currentCursor ? 'disabled' : ''}>
                        ä¸Šä¸€é¡µ
                    </button>
                    <span class="page-info">
                        ${currentCursor ? 'å·²åŠ è½½æ›´å¤š' : 'ç¬¬ä¸€é¡µ'}
                    </span>
                    <button onclick="loadNextPage()" ${!hasMoreImages ? 'disabled' : ''}>
                        ä¸‹ä¸€é¡µ
                    </button>
                `;
            }
        }

        // åŠ è½½ä¸Šä¸€é¡µ
        function loadPreviousPage() {
            // è¿™é‡Œéœ€è¦å®ç°ä¸Šä¸€é¡µé€»è¾‘ï¼Œå¯èƒ½éœ€è¦ç»´æŠ¤å†å²æ¸¸æ ‡
            // æš‚æ—¶ç®€åŒ–ä¸ºé‡æ–°åŠ è½½ç¬¬ä¸€é¡µ
            currentCursor = null;
            loadGalleryImages(document.getElementById('gallerySearch').value);
        }

        // åŠ è½½ä¸‹ä¸€é¡µ
        function loadNextPage() {
            if (hasMoreImages) {
                loadGalleryImages(document.getElementById('gallerySearch').value);
            }
        }

        // åˆ·æ–°å›¾åº“
        function refreshGallery() {
            currentCursor = null;
            selectedImages = [];
            loadGalleryImages(document.getElementById('gallerySearch').value);
        }

        // æ’å…¥é€‰ä¸­çš„å›¾ç‰‡
        function insertSelectedImages() {
            if (selectedImages.length === 0) return;

            const editor = document.getElementById('editor');
            const selectedImageData = galleryImages.filter(img => selectedImages.includes(img.id));

            let imageMarkdown = '';
            selectedImageData.forEach(image => {
                imageMarkdown += `\n![${image.name}](${image.url})\n`;
            });

            // åœ¨å…‰æ ‡ä½ç½®æ’å…¥å›¾ç‰‡
            const cursorPos = editor.selectionStart;
            const textBefore = editor.value.substring(0, cursorPos);
            const textAfter = editor.value.substring(cursorPos);
            editor.value = textBefore + imageMarkdown + textAfter;

            // æ›´æ–°é¢„è§ˆ
            updatePreview();

            // å…³é—­æ¨¡æ€æ¡†
            closeGalleryModal();
        }

        // æœç´¢åŠŸèƒ½
        document.getElementById('gallerySearch').addEventListener('input', debounce(function(e) {
            currentCursor = null;
            selectedImages = [];
            loadGalleryImages(e.target.value);
        }, 500));

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°ï¼ˆä½¿ç”¨å­—èŠ‚å•ä½ï¼‰
        function formatFileSizeBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('galleryModal');
            if (event.target === modal) {
                closeGalleryModal();
            }
        }
    </script>
</body>
</html>